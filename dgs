-- Services
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")

-- Variables
local LocalPlayer = Players.LocalPlayer
local EventsFolder = ReplicatedStorage:WaitForChild("Events")

-- Konfigurasi
_G.AutoAttackEnabled = false
_G.SpeedEnabled = false
_G.ESPEnabled = true
_G.SpeedMultiplier = 1

local BASE_SPEED = 16
local MAX_SPEED_CAP = 45    
local ATTACK_RANGE = 200
local ATTACK_SPEED = 0.015 

-- 1. Remote Hunter
local function GetCurrentAttackRemote()
    local bestRemote = nil
    local highestVersion = -1
    for _, v in pairs(EventsFolder:GetChildren()) do
        if v.Name:find("Attack") then
            local version = tonumber(v.Name:match("%d+"))
            if version and version > highestVersion then
                highestVersion = version
                bestRemote = v
            end
        end
    end
    return bestRemote or EventsFolder:FindFirstChild("AttackV2") or EventsFolder:FindFirstChild("Attack")
end

-- 2. HARDCORE Target Filter: Multi-layer Player Detection
local function isValidEnemy(target)
    if not target or not target:FindFirstChild("Humanoid") or target.Humanoid.Health <= 0 then 
        return false 
    end

    -- LAYER 1: Standard Roblox Player Check
    if Players:GetPlayerFromCharacter(target) then 
        return false 
    end

    -- LAYER 2: Check for Player-only objects (Backpack, PlayerGui, or Scripts usually found in players)
    -- Mobs almost never have a Backpack or a UserId attribute
    if target:FindFirstChild("Backpack") or target:FindFirstChild("PlayerGui") then
        return false
    end

    -- LAYER 3: Name Check (Just in case)
    if target.Name == LocalPlayer.Name then 
        return false 
    end

    -- LAYER 4: Attribute Check (Specific to most Dungeon games)
    local isNPC = target:GetAttribute("IsNPC")
    local mobLevel = target:GetAttribute("MobLevel")
    
    -- If it has no mob indicators but is in the Characters folder, 
    -- and we've already checked it's not a player, we treat it as an enemy.
    -- However, if your friend is STILL being hit, we add this:
    if not isNPC and not mobLevel and target:FindFirstChild("Animate") then
        -- Many games use the default "Animate" script for players but not for mobs.
        -- If the script hits friends, we assume anything with a standard 'Animate' is a player.
        -- Remove the comment below if friends are still being hit:
        -- return false 
    end

    return true
end

-- 3. ESP Highlight Logic
local function ApplyESP(target)
    if not target:FindFirstChild("MobHighlight") then
        local highlight = Instance.new("Highlight")
        highlight.Name = "MobHighlight"
        highlight.Adornee = target
        highlight.FillColor = Color3.fromRGB(255, 0, 0)
        highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
        highlight.Parent = target
        
        target.Humanoid.Died:Connect(function() 
            if highlight then highlight:Destroy() end 
        end)
    end
end

-- 4. Main Loop
task.spawn(function()
    local currentRemote = GetCurrentAttackRemote()
    
    while true do
        -- We check 'workspace' entirely if the 'Characters' folder is unreliable
        local targets = workspace:FindFirstChild("Characters") and workspace.Characters:GetChildren() or workspace:GetChildren()

        for _, enemy in pairs(targets) do
            if isValidEnemy(enemy) then
                if _G.ESPEnabled then ApplyESP(enemy) end
                
                if _G.AutoAttackEnabled and currentRemote then
                    local char = LocalPlayer.Character
                    local root = char and char:FindFirstChild("HumanoidRootPart")
                    local enemyRoot = enemy:FindFirstChild("HumanoidRootPart")
                    
                    if root and enemyRoot then
                        local dist = (root.Position - enemyRoot.Position).Magnitude
                        if dist <= ATTACK_RANGE then
                            -- Pass parameters: (AttackIndex, AnimationIndex, TargetCharacter)
                            currentRemote:FireServer(5, 1, enemy)
                        end
                    end
                end
            end
        end
        task.wait(ATTACK_SPEED)
    end
end)

-- 5. GUI (Same as before, updated title)
local function CreateUI()
    local parent = CoreGui:FindFirstChild("RobloxGui") or LocalPlayer:WaitForChild("PlayerGui")
    if parent:FindFirstChild("DungeonMaster_GUI") then parent.DungeonMaster_GUI:Destroy() end

    local sg = Instance.new("ScreenGui", parent)
    sg.Name = "DungeonMaster_GUI"
    sg.ResetOnSpawn = false

    local main = Instance.new("Frame", sg)
    main.Size = UDim2.new(0, 200, 0, 220)
    main.Position = UDim2.new(0.5, -100, 0.2, 0)
    main.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    main.Active = true
    main.Draggable = true 

    local title = Instance.new("TextLabel", main)
    title.Size = UDim2.new(1, 0, 0, 25)
    title.Text = "DM V2 - FRIEND SAFE"
    title.TextColor3 = Color3.new(1, 1, 1)
    title.BackgroundColor3 = Color3.fromRGB(60, 0, 0)

    local atkBtn = Instance.new("TextButton", main)
    atkBtn.Size = UDim2.new(1, -20, 0, 35); atkBtn.Position = UDim2.new(0, 10, 0, 35)
    atkBtn.Text = "AUTO ATTACK: OFF"; atkBtn.BackgroundColor3 = Color3.fromRGB(100, 0, 0); atkBtn.TextColor3 = Color3.new(1, 1, 1)

    local speedBtn = Instance.new("TextButton", main)
    speedBtn.Size = UDim2.new(1, -20, 0, 35); speedBtn.Position = UDim2.new(0, 10, 0, 75)
    speedBtn.Text = "SPEED: OFF"; speedBtn.BackgroundColor3 = Color3.fromRGB(100, 0, 0); speedBtn.TextColor3 = Color3.new(1, 1, 1)

    local espBtn = Instance.new("TextButton", main)
    espBtn.Size = UDim2.new(1, -20, 0, 35); espBtn.Position = UDim2.new(0, 10, 0, 115)
    espBtn.Text = "ESP: ON"; espBtn.BackgroundColor3 = Color3.fromRGB(0, 100, 0); espBtn.TextColor3 = Color3.new(1, 1, 1)

    local adjBtn = Instance.new("TextButton", main)
    adjBtn.Size = UDim2.new(1, -20, 0, 30); adjBtn.Position = UDim2.new(0, 10, 0, 155)
    adjBtn.Text = "SPEED: 1x"; adjBtn.BackgroundColor3 = Color3.fromRGB(40, 40, 40); adjBtn.TextColor3 = Color3.new(1, 1, 1)

    atkBtn.MouseButton1Click:Connect(function()
        _G.AutoAttackEnabled = not _G.AutoAttackEnabled
        atkBtn.Text = _G.AutoAttackEnabled and "AUTO ATK: ON" or "AUTO ATK: OFF"
        atkBtn.BackgroundColor3 = _G.AutoAttackEnabled and Color3.fromRGB(0, 100, 0) or Color3.fromRGB(100, 0, 0)
    end)

    speedBtn.MouseButton1Click:Connect(function()
        _G.SpeedEnabled = not _G.SpeedEnabled
        speedBtn.Text = _G.SpeedEnabled and "SPEED: ON" or "SPEED: OFF"
        speedBtn.BackgroundColor3 = _G.SpeedEnabled and Color3.fromRGB(0, 100, 0) or Color3.fromRGB(100, 0, 0)
    end)

    espBtn.MouseButton1Click:Connect(function()
        _G.ESPEnabled = not _G.ESPEnabled
        espBtn.Text = _G.ESPEnabled and "ESP: ON" or "ESP: OFF"
        espBtn.BackgroundColor3 = _G.ESPEnabled and Color3.fromRGB(0, 100, 0) or Color3.fromRGB(100, 0, 0)
        if not _G.ESPEnabled then
            for _, v in pairs(workspace:GetDescendants()) do if v.Name == "MobHighlight" then v:Destroy() end end
        end
    end)

    adjBtn.MouseButton1Click:Connect(function()
        _G.SpeedMultiplier = (_G.SpeedMultiplier % 5) + 1
        adjBtn.Text = "SPEED: " .. _G.SpeedMultiplier .. "x"
    end)
end

-- 6. Speed Modifier
RunService.Heartbeat:Connect(function()
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
        local targetSpeed = _G.SpeedEnabled and (BASE_SPEED * _G.SpeedMultiplier) or BASE_SPEED
        if targetSpeed > MAX_SPEED_CAP then targetSpeed = MAX_SPEED_CAP end
        LocalPlayer.Character.Humanoid.WalkSpeed = targetSpeed
    end
end)

CreateUI()
