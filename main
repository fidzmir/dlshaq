-- Services
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")

-- Variables
local LocalPlayer = Players.LocalPlayer
local EventsFolder = ReplicatedStorage:WaitForChild("Events")

-- Konfigurasi
_G.AutoAttackEnabled = false
_G.SpeedEnabled = false
_G.ESPEnabled = true
_G.SafeFarmEnabled = false -- This replaces the "Visual Freeze"
_G.SpeedMultiplier = 1

local BASE_SPEED = 16
local MAX_SPEED_CAP = 45    
local ATTACK_RANGE = 200
local ATTACK_SPEED = 0.12   

-- 1. Remote Hunter (Dynamic Versioning)
local function GetCurrentAttackRemote()
    local bestRemote = nil
    local highestVersion = -1
    for _, v in pairs(EventsFolder:GetChildren()) do
        if v.Name:find("Attack") then
            local version = tonumber(v.Name:match("%d+"))
            if version and version > highestVersion then
                highestVersion = version
                bestRemote = v
            end
        end
    end
    return bestRemote or EventsFolder:FindFirstChild("AttackV2") or EventsFolder:FindFirstChild("Attack")
end

-- 2. Target Filter (Useful Fallback)
local function isValidEnemy(target)
    if target and target:FindFirstChild("Humanoid") and target.Humanoid.Health > 0 then
        if target == LocalPlayer.Character then return false end 
        return true 
    end
    return false
end

-- 3. ESP Logic
local function ApplyHighlight(target, color, name)
    if not target:FindFirstChild(name) then
        local highlight = Instance.new("Highlight", target)
        highlight.Name = name
        highlight.FillColor = color
        highlight.FillTransparency = 0.5
        highlight.OutlineTransparency = 0
    end
end

-- 4. Main Loop (Attack + Safe Farm)
task.spawn(function()
    while true do
        local currentRemote = GetCurrentAttackRemote()
        local charFolder = workspace:FindFirstChild("Characters")
        local myChar = LocalPlayer.Character
        local myRoot = myChar and myChar:FindFirstChild("HumanoidRootPart")

        if charFolder and myRoot then
            for _, obj in pairs(charFolder:GetChildren()) do
                if isValidEnemy(obj) then
                    local eRoot = obj:FindFirstChild("HumanoidRootPart")
                    if eRoot then
                        -- ESP Update
                        if _G.ESPEnabled then ApplyHighlight(obj, Color3.fromRGB(255, 0, 0), "MobHighlight") end
                        
                        -- SAFE FARM LOGIC (Above Head)
                        if _G.SafeFarmEnabled then
                            -- This forces the mob to stay under you and stops their physics
                            eRoot.AssemblyLinearVelocity = Vector3.new(0,0,0)
                            if (myRoot.Position - eRoot.Position).Magnitude < 15 then
                                -- Slightly push them down or stay above them
                                eRoot.CFrame = CFrame.new(eRoot.Position, myRoot.Position)
                            end
                        end

                        -- AUTO ATTACK
                        if _G.AutoAttackEnabled and currentRemote then
                            if (myRoot.Position - eRoot.Position).Magnitude <= ATTACK_RANGE then
                                currentRemote:FireServer(5, 1, obj)
                            end
                        end
                    end
                end
            end
        end
        task.wait(ATTACK_SPEED)
    end
end)

-- 5. GUI Setup
local function CreateUI()
    local parent = CoreGui:FindFirstChild("RobloxGui") or LocalPlayer:WaitForChild("PlayerGui")
    if parent:FindFirstChild("DungeonMaster_Safe") then parent.DungeonMaster_Safe:Destroy() end

    local sg = Instance.new("ScreenGui", parent); sg.Name = "DungeonMaster_Safe"; sg.ResetOnSpawn = false
    local main = Instance.new("Frame", sg)
    main.Size = UDim2.new(0, 200, 0, 250); main.Position = UDim2.new(0.5, -100, 0.2, 0)
    main.BackgroundColor3 = Color3.fromRGB(20, 20, 20); main.Active = true; main.Draggable = true 

    local function MakeBtn(text, pos, color)
        local b = Instance.new("TextButton", main)
        b.Size = UDim2.new(1, -20, 0, 35); b.Position = pos
        b.Text = text; b.BackgroundColor3 = color; b.TextColor3 = Color3.new(1, 1, 1); b.BorderSizePixel = 0
        b.Font = Enum.Font.SourceSansBold; b.TextSize = 14
        return b
    end

    local atkBtn = MakeBtn("AUTO ATTACK: OFF", UDim2.new(0, 10, 0, 10), Color3.fromRGB(150, 0, 0))
    local safeBtn = MakeBtn("SAFE FARM: OFF", UDim2.new(0, 10, 0, 55), Color3.fromRGB(0, 80, 150))
    local speedBtn = MakeBtn("SPEED: OFF", UDim2.new(0, 10, 0, 100), Color3.fromRGB(150, 0, 0))
    local espBtn = MakeBtn("ESP: ON", UDim2.new(0, 10, 0, 145), Color3.fromRGB(0, 150, 0))
    local adjBtn = MakeBtn("SPEED: 1x", UDim2.new(0, 10, 0, 190), Color3.fromRGB(60, 60, 60))

    atkBtn.MouseButton1Click:Connect(function()
        _G.AutoAttackEnabled = not _G.AutoAttackEnabled
        atkBtn.Text = _G.AutoAttackEnabled and "AUTO ATK: ON" or "AUTO ATK: OFF"
        atkBtn.BackgroundColor3 = _G.AutoAttackEnabled and Color3.fromRGB(0, 150, 0) or Color3.fromRGB(150, 0, 0)
    end)

    safeBtn.MouseButton1Click:Connect(function()
        _G.SafeFarmEnabled = not _G.SafeFarmEnabled
        safeBtn.Text = _G.SafeFarmEnabled and "SAFE FARM: ON" or "SAFE FARM: OFF"
        safeBtn.BackgroundColor3 = _G.SafeFarmEnabled and Color3.fromRGB(0, 150, 255) or Color3.fromRGB(0, 80, 150)
    end)

    speedBtn.MouseButton1Click:Connect(function()
        _G.SpeedEnabled = not _G.SpeedEnabled
        speedBtn.Text = _G.SpeedEnabled and "SPEED: ON" or "SPEED: OFF"
        speedBtn.BackgroundColor3 = _G.SpeedEnabled and Color3.fromRGB(0, 150, 0) or Color3.fromRGB(150, 0, 0)
    end)

    adjBtn.MouseButton1Click:Connect(function()
        _G.SpeedMultiplier = (_G.SpeedMultiplier % 5) + 1
        adjBtn.Text = "SPEED: " .. _G.SpeedMultiplier .. "x"
    end)
    
    espBtn.MouseButton1Click:Connect(function()
        _G.ESPEnabled = not _G.ESPEnabled
        espBtn.Text = _G.ESPEnabled and "ESP: ON" or "ESP: OFF"
    end)
end

-- 6. Heartbeat Speed (Anti-Ban Throttled)
RunService.Heartbeat:Connect(function()
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
        local hum = LocalPlayer.Character.Humanoid
        local targetSpeed = _G.SpeedEnabled and (BASE_SPEED * _G.SpeedMultiplier) or BASE_SPEED
        if targetSpeed > MAX_SPEED_CAP then targetSpeed = MAX_SPEED_CAP end
        hum.WalkSpeed = targetSpeed
    end
end)

CreateUI()
