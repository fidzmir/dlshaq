-- Services
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")

-- Variables
local LocalPlayer = Players.LocalPlayer
local EventsFolder = ReplicatedStorage:WaitForChild("Events")

-- Konfigurasi
_G.AutoAttackEnabled = false
_G.SpeedEnabled = false
_G.ESPEnabled = true
_G.ChestESPEnabled = true
_G.MobFreeze = false -- THE NEW FEATURE
_G.SpeedMultiplier = 1

local BASE_SPEED = 16
local MAX_SPEED_CAP = 45    
local ATTACK_RANGE = 200
local ATTACK_SPEED = 0.12   

-- 1. Remote Hunter
local function GetCurrentAttackRemote()
    local bestRemote = nil
    local highestVersion = -1
    for _, v in pairs(EventsFolder:GetChildren()) do
        if v.Name:find("Attack") then
            local version = tonumber(v.Name:match("%d+"))
            if version and version > highestVersion then
                highestVersion = version
                bestRemote = v
            end
        end
    end
    return bestRemote or EventsFolder:FindFirstChild("AttackV2") or EventsFolder:FindFirstChild("Attack")
end

-- 2. Filters
local function isValidEnemy(target)
    if target and target:FindFirstChild("Humanoid") and target.Humanoid.Health > 0 then
        if target == LocalPlayer.Character then return false end 
        return true -- Fallback set to true as requested
    end
    return false
end

-- 3. ESP & Freeze Logic
local function ApplyHighlight(target, color, name)
    if not target:FindFirstChild(name) then
        local highlight = Instance.new("Highlight", target)
        highlight.Name = name
        highlight.FillColor = color
        highlight.FillTransparency = 0.4
    end
end

-- 4. Main Loop
task.spawn(function()
    while true do
        local currentRemote = GetCurrentAttackRemote()
        local charFolder = workspace:FindFirstChild("Characters")
        
        if charFolder then
            for _, obj in pairs(charFolder:GetChildren()) do
                if isValidEnemy(obj) then
                    -- MOB FREEZE LOGIC
                    local root = obj:FindFirstChild("HumanoidRootPart")
                    if root then
                        -- If Freeze is ON, we anchor the enemy so they can't move
                        root.Anchored = _G.MobFreeze
                    end

                    -- MOB ESP
                    if _G.ESPEnabled then ApplyHighlight(obj, Color3.fromRGB(255, 0, 0), "MobHighlight") end
                    
                    -- AUTO ATTACK
                    if _G.AutoAttackEnabled and currentRemote then
                        local myRoot = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
                        if myRoot and root and (myRoot.Position - root.Position).Magnitude <= ATTACK_RANGE then
                            currentRemote:FireServer(5, 1, obj)
                        end
                    end
                end
            end
        end
        task.wait(ATTACK_SPEED)
    end
end)

-- 5. GUI Setup
local function CreateUI()
    local parent = CoreGui:FindFirstChild("RobloxGui") or LocalPlayer:WaitForChild("PlayerGui")
    if parent:FindFirstChild("DungeonMaster_ULTRA") then parent.DungeonMaster_ULTRA:Destroy() end

    local sg = Instance.new("ScreenGui", parent); sg.Name = "DungeonMaster_ULTRA"; sg.ResetOnSpawn = false
    local main = Instance.new("Frame", sg)
    main.Size = UDim2.new(0, 200, 0, 280); main.Position = UDim2.new(0.5, -100, 0.2, 0)
    main.BackgroundColor3 = Color3.fromRGB(15, 15, 15); main.Active = true; main.Draggable = true 

    local function MakeBtn(text, pos, color)
        local b = Instance.new("TextButton", main)
        b.Size = UDim2.new(1, -20, 0, 30); b.Position = pos
        b.Text = text; b.BackgroundColor3 = color; b.TextColor3 = Color3.new(1, 1, 1); b.BorderSizePixel = 0
        return b
    end

    local atkBtn = MakeBtn("AUTO ATTACK: OFF", UDim2.new(0, 10, 0, 10), Color3.fromRGB(150, 0, 0))
    local freezeBtn = MakeBtn("FREEZE MOBS: OFF", UDim2.new(0, 10, 0, 45), Color3.fromRGB(70, 0, 150)) -- Purple for Freeze
    local speedBtn = MakeBtn("SPEED: OFF", UDim2.new(0, 10, 0, 80), Color3.fromRGB(150, 0, 0))
    local espBtn = MakeBtn("MOB ESP: ON", UDim2.new(0, 10, 0, 115), Color3.fromRGB(0, 150, 0))
    local chestBtn = MakeBtn("CHEST ESP: ON", UDim2.new(0, 10, 0, 150), Color3.fromRGB(0, 150, 0))
    local adjBtn = MakeBtn("SPEED: 1x", UDim2.new(0, 10, 0, 185), Color3.fromRGB(60, 60, 60))

    -- Logic
    atkBtn.MouseButton1Click:Connect(function()
        _G.AutoAttackEnabled = not _G.AutoAttackEnabled
        atkBtn.Text = _G.AutoAttackEnabled and "AUTO ATK: ON" or "AUTO ATK: OFF"
        atkBtn.BackgroundColor3 = _G.AutoAttackEnabled and Color3.fromRGB(0, 150, 0) or Color3.fromRGB(150, 0, 0)
    end)

    freezeBtn.MouseButton1Click:Connect(function()
        _G.MobFreeze = not _G.MobFreeze
        freezeBtn.Text = _G.MobFreeze and "FREEZE MOBS: ON" or "FREEZE MOBS: OFF"
        freezeBtn.BackgroundColor3 = _G.MobFreeze and Color3.fromRGB(110, 0, 255) or Color3.fromRGB(70, 0, 150)
        
        -- If turning OFF, unanchor everyone immediately
        if not _G.MobFreeze then
            local charFolder = workspace:FindFirstChild("Characters")
            if charFolder then
                for _, m in pairs(charFolder:GetChildren()) do
                    if m:FindFirstChild("HumanoidRootPart") then m.HumanoidRootPart.Anchored = false end
                end
            end
        end
    end)

    speedBtn.MouseButton1Click:Connect(function()
        _G.SpeedEnabled = not _G.SpeedEnabled
        speedBtn.Text = _G.SpeedEnabled and "SPEED: ON" or "SPEED: OFF"
        speedBtn.BackgroundColor3 = _G.SpeedEnabled and Color3.fromRGB(0, 150, 0) or Color3.fromRGB(150, 0, 0)
    end)

    adjBtn.MouseButton1Click:Connect(function()
        _G.SpeedMultiplier = (_G.SpeedMultiplier % 5) + 1
        adjBtn.Text = "SPEED: " .. _G.SpeedMultiplier .. "x"
    end)
    
    -- Chest ESP Toggle (Simplified for brevity)
    chestBtn.MouseButton1Click:Connect(function() _G.ChestESPEnabled = not _G.ChestESPEnabled end)
    espBtn.MouseButton1Click:Connect(function() _G.ESPEnabled = not _G.ESPEnabled end)
end

-- 6. Speed Modifier
RunService.Heartbeat:Connect(function()
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
        local targetSpeed = _G.SpeedEnabled and (BASE_SPEED * _G.SpeedMultiplier) or BASE_SPEED
        if targetSpeed > MAX_SPEED_CAP then targetSpeed = MAX_SPEED_CAP end
        LocalPlayer.Character.Humanoid.WalkSpeed = targetSpeed
    end
end)

CreateUI()
