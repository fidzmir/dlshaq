-- Services
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")

-- Variables
local LocalPlayer = Players.LocalPlayer
local EventsFolder = ReplicatedStorage:WaitForChild("Events")

-- Konfigurasi
_G.AutoAttackEnabled = false
_G.SpeedEnabled = false
_G.ESPEnabled = true
_G.ChestESPEnabled = true
_G.SpeedMultiplier = 1

local BASE_SPEED = 16
local MAX_SPEED_CAP = 45    
local ATTACK_RANGE = 200
local ATTACK_SPEED = 0.01   

-- 1. Remote Hunter
local function GetCurrentAttackRemote()
    local bestRemote = nil
    local highestVersion = -1
    for _, v in pairs(EventsFolder:GetChildren()) do
        if v.Name:find("Attack") then
            local version = tonumber(v.Name:match("%d+"))
            if version and version > highestVersion then
                highestVersion = version
                bestRemote = v
            end
        end
    end
    return bestRemote or EventsFolder:FindFirstChild("AttackV2") or EventsFolder:FindFirstChild("Attack")
end

-- 2. Filters
local function isValidEnemy(target)
    if target and target:FindFirstChild("Humanoid") and target.Humanoid.Health > 0 then
        if target == LocalPlayer.Character then return false end 
        local targetName = target.Name:lower()
        if targetName:find("npc") and not target:GetAttribute("MobLevel") then return false end
        return true -- Your useful fallback
    end
    return false
end

local function isChest(obj)
    local name = obj.Name:lower()
    return name:find("chest") or name:find("treasure") or name:find("crate") or name:find("reward")
end

-- 3. ESP Logic (Highlights)
local function ApplyHighlight(target, color, name)
    if not target:FindFirstChild(name) then
        local highlight = Instance.new("Highlight")
        highlight.Name = name
        highlight.Adornee = target
        highlight.FillColor = color
        highlight.FillTransparency = 0.4
        highlight.OutlineColor = Color3.new(1, 1, 1)
        highlight.Parent = target
        
        -- Cleanup for mobs
        local hum = target:FindFirstChild("Humanoid")
        if hum then hum.Died:Connect(function() highlight:Destroy() end) end
    end
end

-- 4. Main Loop
task.spawn(function()
    while true do
        local currentRemote = GetCurrentAttackRemote()
        
        -- Scan Workspace for Mobs and Chests
        for _, obj in pairs(workspace:GetDescendants()) do
            -- Mob ESP & Attack
            if obj.Parent and obj.Parent.Name == "Characters" and isValidEnemy(obj) then
                if _G.ESPEnabled then ApplyHighlight(obj, Color3.fromRGB(255, 0, 0), "MobHighlight") end
                if _G.AutoAttackEnabled and currentRemote then
                    local root = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
                    local eRoot = obj:FindFirstChild("HumanoidRootPart")
                    if root and eRoot and (root.Position - eRoot.Position).Magnitude <= ATTACK_RANGE then
                        currentRemote:FireServer(5, 1, obj)
                    end
                end
            -- Chest ESP
            elseif isChest(obj) and _G.ChestESPEnabled then
                ApplyHighlight(obj, Color3.fromRGB(255, 215, 0), "ChestHighlight")
            end
        end
        task.wait(ATTACK_SPEED)
    end
end)

-- 5. GUI Setup
local function CreateUI()
    local parent = CoreGui:FindFirstChild("RobloxGui") or LocalPlayer:WaitForChild("PlayerGui")
    if parent:FindFirstChild("DungeonMaster_V2") then parent.DungeonMaster_V2:Destroy() end

    local sg = Instance.new("ScreenGui", parent); sg.Name = "DungeonMaster_V2"; sg.ResetOnSpawn = false
    local main = Instance.new("Frame", sg)
    main.Size = UDim2.new(0, 200, 0, 240); main.Position = UDim2.new(0.5, -100, 0.2, 0)
    main.BackgroundColor3 = Color3.fromRGB(20, 20, 20); main.Active = true; main.Draggable = true 

    local function MakeBtn(text, pos, color)
        local b = Instance.new("TextButton", main)
        b.Size = UDim2.new(1, -20, 0, 30); b.Position = pos
        b.Text = text; b.BackgroundColor3 = color; b.TextColor3 = Color3.new(1, 1, 1)
        return b
    end

    local atkBtn = MakeBtn("AUTO ATTACK: OFF", UDim2.new(0, 10, 0, 10), Color3.fromRGB(150, 0, 0))
    local speedBtn = MakeBtn("SPEED: OFF", UDim2.new(0, 10, 0, 45), Color3.fromRGB(150, 0, 0))
    local espBtn = MakeBtn("MOB ESP: ON", UDim2.new(0, 10, 0, 80), Color3.fromRGB(0, 150, 0))
    local chestBtn = MakeBtn("CHEST ESP: ON", UDim2.new(0, 10, 0, 115), Color3.fromRGB(0, 150, 0))
    
    local adjBtn = MakeBtn("SPEED: 1x", UDim2.new(0, 10, 0, 150), Color3.fromRGB(60, 60, 60))
    local remoteLabel = Instance.new("TextLabel", main)
    remoteLabel.Size = UDim2.new(1, 0, 0, 40); remoteLabel.Position = UDim2.new(0, 0, 0, 185)
    remoteLabel.Text = "Searching Remote..."; remoteLabel.TextColor3 = Color3.new(0.7, 0.7, 0.7); remoteLabel.BackgroundTransparency = 1; remoteLabel.TextSize = 12

    -- Logic
    atkBtn.MouseButton1Click:Connect(function()
        _G.AutoAttackEnabled = not _G.AutoAttackEnabled
        atkBtn.Text = _G.AutoAttackEnabled and "AUTO ATK: ON" or "AUTO ATK: OFF"
        atkBtn.BackgroundColor3 = _G.AutoAttackEnabled and Color3.fromRGB(0, 150, 0) or Color3.fromRGB(150, 0, 0)
    end)

    speedBtn.MouseButton1Click:Connect(function()
        _G.SpeedEnabled = not _G.SpeedEnabled
        speedBtn.Text = _G.SpeedEnabled and "SPEED: ON" or "SPEED: OFF"
        speedBtn.BackgroundColor3 = _G.SpeedEnabled and Color3.fromRGB(0, 150, 0) or Color3.fromRGB(150, 0, 0)
    end)

    espBtn.MouseButton1Click:Connect(function()
        _G.ESPEnabled = not _G.ESPEnabled
        espBtn.Text = _G.ESPEnabled and "MOB ESP: ON" or "MOB ESP: OFF"
        espBtn.BackgroundColor3 = _G.ESPEnabled and Color3.fromRGB(0, 150, 0) or Color3.fromRGB(150, 0, 0)
        if not _G.ESPEnabled then for _, v in pairs(workspace:GetDescendants()) do if v.Name == "MobHighlight" then v:Destroy() end end end
    end)

    chestBtn.MouseButton1Click:Connect(function()
        _G.ChestESPEnabled = not _G.ChestESPEnabled
        chestBtn.Text = _G.ChestESPEnabled and "CHEST ESP: ON" or "CHEST ESP: OFF"
        chestBtn.BackgroundColor3 = _G.ChestESPEnabled and Color3.fromRGB(0, 150, 0) or Color3.fromRGB(150, 0, 0)
        if not _G.ChestESPEnabled then for _, v in pairs(workspace:GetDescendants()) do if v.Name == "ChestHighlight" then v:Destroy() end end end
    end)

    adjBtn.MouseButton1Click:Connect(function()
        _G.SpeedMultiplier = (_G.SpeedMultiplier % 5) + 1
        adjBtn.Text = "SPEED: " .. _G.SpeedMultiplier .. "x"
    end)

    task.spawn(function()
        while task.wait(1) do
            local r = GetCurrentAttackRemote()
            remoteLabel.Text = "Active Remote:\n" .. (r and r.Name or "None")
        end
    end)
end

-- 6. Speed Modifier
RunService.Heartbeat:Connect(function()
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
        local targetSpeed = _G.SpeedEnabled and (BASE_SPEED * _G.SpeedMultiplier) or BASE_SPEED
        if targetSpeed > MAX_SPEED_CAP then targetSpeed = MAX_SPEED_CAP end
        LocalPlayer.Character.Humanoid.WalkSpeed = targetSpeed
    end
end)

CreateUI()
