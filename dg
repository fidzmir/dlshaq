local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")

-- Setup Attack Remotes (V1 to V5)
local EventsFolder = ReplicatedStorage:WaitForChild("Events")
local AttackRemotes = {}
for i = 1, 5 do
    local name = "AttackV" .. i
    local event = EventsFolder:FindFirstChild(name)
    if event then table.insert(AttackRemotes, event) end
end

-- Konfigurasi
_G.AutoAttackEnabled = false
_G.SpeedEnabled = false
_G.SpeedMultiplier = 1
local BASE_SPEED = 16
local ATTACK_RANGE = 200
local ATTACK_SPEED = 0.07 -- Slightly slower to allow game to process death state

-- 1. Fungsi Cek Ally (Enhanced)
local function isAlly(target)
    if not target or not target.Parent then return true end -- Ignore if being deleted
    
    -- Cara 1: Nama mengandung kata "Ally" atau "Friend"
    if string.find(target.Name, "Ally") or string.find(target.Name, "Friend") then
        return true
    end

    -- Cara 2: attribute Team = Allies
    if target:GetAttribute("Team") == "Allies" then
        return true
    end

    -- Cara 3: target ada di folder workspace.Allies
    local alliesFolder = workspace:FindFirstChild("Allies")
    if alliesFolder and alliesFolder:FindFirstChild(target.Name) then
        return true
    end

    return false
end

-- 2. Ambil target terdekat (Fixed Death Logic)
local function getClosestTargets(maxTargets)
    local char = LocalPlayer.Character
    local root = char and char:FindFirstChild("HumanoidRootPart")
    if not root then return {} end

    local candidates = {}
    local charFolder = workspace:FindFirstChild("Characters")
    
    if charFolder then
        for _, target in pairs(charFolder:GetChildren()) do
            -- Safety checks: Must be alive, must have a root part, and must still be in workspace
            local hum = target:FindFirstChildOfClass("Humanoid")
            local tRoot = target:FindFirstChild("HumanoidRootPart")
            
            if target ~= char and tRoot and hum and hum.Health > 0.1 then
                local targetPlayer = Players:GetPlayerFromCharacter(target)
                
                -- Verify it is NOT a player AND NOT an ally
                if not targetPlayer and not isAlly(target) then
                    local distance = (root.Position - tRoot.Position).Magnitude
                    if distance <= ATTACK_RANGE then
                        table.insert(candidates, {
                            model = target,
                            dist = distance
                        })
                    end
                end
            end
        end
    end
    
    table.sort(candidates, function(a, b) return a.dist < b.dist end)
    
    local out = {}
    for i = 1, math.min(maxTargets, #candidates) do
        table.insert(out, candidates[i])
    end
    return out
end

-- 3. GUI UI (Standard Draggable)
local function CreateUI()
    local parent = CoreGui:FindFirstChild("RobloxGui") or LocalPlayer:WaitForChild("PlayerGui")
    if parent:FindFirstChild("MageNPC_V3_GUI") then parent.MageNPC_V3_GUI:Destroy() end

    local sg = Instance.new("ScreenGui", parent); sg.Name = "MageNPC_V3_GUI"; sg.ResetOnSpawn = false
    local main = Instance.new("Frame", sg)
    main.Size = UDim2.new(0, 200, 0, 160); main.Position = UDim2.new(0.5, -100, 0.2, 0)
    main.BackgroundColor3 = Color3.fromRGB(20, 20, 20); main.Active = true; main.Draggable = true 

    local atkBtn = Instance.new("TextButton", main)
    atkBtn.Size = UDim2.new(1, -20, 0, 40); atkBtn.Position = UDim2.new(0, 10, 0, 10)
    atkBtn.Text = "AUTO ATTACK: OFF"; atkBtn.BackgroundColor3 = Color3.fromRGB(150, 0, 0); atkBtn.TextColor3 = Color3.new(1, 1, 1)

    local speedBtn = Instance.new("TextButton", main)
    speedBtn.Size = UDim2.new(1, -20, 0, 40); speedBtn.Position = UDim2.new(0, 10, 0, 55)
    speedBtn.Text = "SPEED: OFF"; speedBtn.BackgroundColor3 = Color3.fromRGB(150, 0, 0); speedBtn.TextColor3 = Color3.new(1, 1, 1)

    local label = Instance.new("TextLabel", main)
    label.Size = UDim2.new(1, 0, 0, 20); label.Position = UDim2.new(0, 0, 0, 100)
    label.Text = "SPEED: 1x"; label.TextColor3 = Color3.new(1, 1, 1); label.BackgroundTransparency = 1

    local adjBtn = Instance.new("TextButton", main)
    adjBtn.Size = UDim2.new(1, -20, 0, 30); adjBtn.Position = UDim2.new(0, 10, 0, 125)
    adjBtn.Text = "SET SPEED (1-5x)"; adjBtn.BackgroundColor3 = Color3.fromRGB(45, 45, 45); adjBtn.TextColor3 = Color3.new(1, 1, 1)

    atkBtn.MouseButton1Click:Connect(function()
        _G.AutoAttackEnabled = not _G.AutoAttackEnabled
        atkBtn.Text = _G.AutoAttackEnabled and "AUTO ATK: ON" or "AUTO ATK: OFF"
        atkBtn.BackgroundColor3 = _G.AutoAttackEnabled and Color3.fromRGB(0, 150, 0) or Color3.fromRGB(150, 0, 0)
    end)

    speedBtn.MouseButton1Click:Connect(function()
        _G.SpeedEnabled = not _G.SpeedEnabled
        speedBtn.Text = _G.SpeedEnabled and "SPEED: ON" or "SPEED: OFF"
        speedBtn.BackgroundColor3 = _G.SpeedEnabled and Color3.fromRGB(0, 150, 0) or Color3.fromRGB(150, 0, 0)
    end)

    adjBtn.MouseButton1Click:Connect(function()
        _G.SpeedMultiplier = _G.SpeedMultiplier + 1
        if _G.SpeedMultiplier > 5 then _G.SpeedMultiplier = 1 end
        label.Text = "SPEED: " .. _G.SpeedMultiplier .. "x"
    end)
end

-- 4. Attack Loop
task.spawn(function()
    while true do
        if _G.AutoAttackEnabled then
            local targets = getClosestTargets(1) -- Set to 1 for more stability, 5 for clearing crowds
            for _, data in pairs(targets) do
                -- Double Check Health right before firing
                if data.model:FindFirstChildOfClass("Humanoid") and data.model.Humanoid.Health > 0 then
                    for _, remote in pairs(AttackRemotes) do
                        remote:FireServer(5, 1, data.model)
                    end
                end
            end
        end
        task.wait(ATTACK_SPEED)
    end
end)

-- 5. Speed Modifier
RunService.Stepped:Connect(function()
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
        LocalPlayer.Character.Humanoid.WalkSpeed = _G.SpeedEnabled and (BASE_SPEED * _G.SpeedMultiplier) or BASE_SPEED
    end
end)

CreateUI()
