-- Cek apakah target adalah teman
local function isAlly(target)
    -- Cara 1: nama mengandung kata "Ally" atau "Friend"
    if string.find(target.Name, "Ally") or string.find(target.Name, "Friend") then
        return true
    end

    -- Cara 2: attribute Team = Allies
    if target:GetAttribute("Team") == "Allies" then
        return true
    end

    -- Cara 3: target ada di folder workspace.Allies
    local alliesFolder = workspace:FindFirstChild("Allies")
    if alliesFolder and alliesFolder:FindFirstChild(target.Name) then
        return true
    end

    return false
end

-- Ambil target terdekat (hanya NPC musuh)
local function getClosestTargets(maxTargets)
    local candidates = {}
    for _, target in pairs(workspace.Characters:GetChildren()) do
        if target ~= char and target:FindFirstChild("HumanoidRootPart") then
            local targetPlayer = Players:GetPlayerFromCharacter(target)
            -- skip jika target adalah player atau teman
            if not targetPlayer and not isAlly(target) then
                local humanoid = target:FindFirstChildOfClass("Humanoid")
                local targetRoot = target:FindFirstChild("HumanoidRootPart")
                if humanoid and humanoid.Health > 0 then
                    table.insert(candidates, {
                        model = target,
                        root = targetRoot,
                        humanoid = humanoid,
                        dist = (root.Position - targetRoot.Position).Magnitude
                    })
                end
            end
        end
    end
    table.sort(candidates, function(a, b) return a.dist < b.dist end)
    local out = {}
    for i = 1, math.min(maxTargets, #candidates) do
        table.insert(out, candidates[i])
    end
    return out
end
