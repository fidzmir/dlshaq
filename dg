local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")

-- Setup Attack Remotes (V1 to V5)
local EventsFolder = ReplicatedStorage:WaitForChild("Events")
local AttackRemotes = {}
for i = 1, 5 do
    local name = "AttackV" .. i
    local event = EventsFolder:FindFirstChild(name)
    if event then table.insert(AttackRemotes, event) end
end

-- Konfigurasi
_G.AutoAttackEnabled = false
_G.SpeedEnabled = false
_G.SpeedMultiplier = 1
local BASE_SPEED = 16
local ATTACK_RANGE = 200
local ATTACK_SPEED = 0.05 

-- 1. Fungsi Cek Ally (Simplified)
local function isAlly(target)
    if not target then return true end
    
    -- Cek Folder Allies
    local alliesFolder = workspace:FindFirstChild("Allies")
    if alliesFolder and alliesFolder:FindFirstChild(target.Name) then
        return true
    end

    -- Cek Nama & Attribute
    local name = target.Name:lower()
    if name:find("ally") or name:find("friend") or target:GetAttribute("Team") == "Allies" then
        return true
    end

    return false
end

-- 2. Ambil Target Terdekat (Simplified & More Aggressive)
local function getClosestTargets(maxTargets)
    local char = LocalPlayer.Character
    local root = char and char:FindFirstChild("HumanoidRootPart")
    if not root then return {} end

    local candidates = {}
    local charFolder = workspace:FindFirstChild("Characters")
    
    if charFolder then
        for _, target in pairs(charFolder:GetChildren()) do
            -- Pastikan target punya bagian tubuh untuk dipukul
            local targetRoot = target:FindFirstChild("HumanoidRootPart") or target:FindFirstChild("Head")
            
            if target ~= char and targetRoot then
                local targetPlayer = Players:GetPlayerFromCharacter(target)
                
                -- FILTER: Bukan Player Dan Bukan Ally
                if not targetPlayer and not isAlly(target) then
                    local dist = (root.Position - targetRoot.Position).Magnitude
                    if dist <= ATTACK_RANGE then
                        table.insert(candidates, {
                            model = target,
                            dist = dist
                        })
                    end
                end
            end
        end
    end
    
    table.sort(candidates, function(a, b) return a.dist < b.dist end)
    
    local out = {}
    for i = 1, math.min(maxTargets, #candidates) do
        table.insert(out, candidates[i])
    end
    return out
end

-- 3. GUI UI
local function CreateUI()
    local parent = CoreGui:FindFirstChild("RobloxGui") or LocalPlayer:WaitForChild("PlayerGui")
    if parent:FindFirstChild("MageNPC_FIXED_GUI") then parent.MageNPC_FIXED_GUI:Destroy() end

    local sg = Instance.new("ScreenGui", parent); sg.Name = "MageNPC_FIXED_GUI"; sg.ResetOnSpawn = false
    local main = Instance.new("Frame", sg)
    main.Size = UDim2.new(0, 200, 0, 160); main.Position = UDim2.new(0.5, -100, 0.2, 0)
    main.BackgroundColor3 = Color3.fromRGB(25, 25, 25); main.Active = true; main.Draggable = true 

    local atkBtn = Instance.new("TextButton", main)
    atkBtn.Size = UDim2.new(1, -20, 0, 40); atkBtn.Position = UDim2.new(0, 10, 0, 10)
    atkBtn.Text = "AUTO ATTACK: OFF"; atkBtn.BackgroundColor3 = Color3.fromRGB(150, 0, 0); atkBtn.TextColor3 = Color3.new(1, 1, 1)

    local speedBtn = Instance.new("TextButton", main)
    speedBtn.Size = UDim2.new(1, -20, 0, 40); speedBtn.Position = UDim2.new(0, 10, 0, 55)
    speedBtn.Text = "SPEED: OFF"; speedBtn.BackgroundColor3 = Color3.fromRGB(150, 0, 0); speedBtn.TextColor3 = Color3.new(1, 1, 1)

    local label = Instance.new("TextLabel", main)
    label.Size = UDim2.new(1, 0, 0, 20); label.Position = UDim2.new(0, 0, 0, 100)
    label.Text = "SPEED: 1x"; label.TextColor3 = Color3.new(1, 1, 1); label.BackgroundTransparency = 1

    local adjBtn = Instance.new("TextButton", main)
    adjBtn.Size = UDim2.new(1, -20, 0, 30); adjBtn.Position = UDim2.new(0, 10, 0, 125)
    adjBtn.Text = "SET SPEED (1-5x)"; adjBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 60); adjBtn.TextColor3 = Color3.new(1, 1, 1)

    atkBtn.MouseButton1Click:Connect(function()
        _G.AutoAttackEnabled = not _G.AutoAttackEnabled
        atkBtn.Text = _G.AutoAttackEnabled and "AUTO ATK: ON" or "AUTO ATK: OFF"
        atkBtn.BackgroundColor3 = _G.AutoAttackEnabled and Color3.fromRGB(0, 150, 0) or Color3.fromRGB(150, 0, 0)
    end)

    speedBtn.MouseButton1Click:Connect(function()
        _G.SpeedEnabled = not _G.SpeedEnabled
        speedBtn.Text = _G.SpeedEnabled and "SPEED: ON" or "SPEED: OFF"
        speedBtn.BackgroundColor3 = _G.SpeedEnabled and Color3.fromRGB(0, 150, 0) or Color3.fromRGB(150, 0, 0)
    end)

    adjBtn.MouseButton1Click:Connect(function()
        _G.SpeedMultiplier = _G.SpeedMultiplier + 1
        if _G.SpeedMultiplier > 5 then _G.SpeedMultiplier = 1 end
        label.Text = "SPEED: " .. _G.SpeedMultiplier .. "x"
    end)
end

-- 4. Attack Loop
task.spawn(function()
    while true do
        if _G.AutoAttackEnabled then
            local targets = getClosestTargets(3) -- Hajar 3 monster sekaligus
            for _, data in pairs(targets) do
                for _, remote in pairs(AttackRemotes) do
                    remote:FireServer(5, 1, data.model)
                end
            end
        end
        task.wait(ATTACK_SPEED)
    end
end)

-- 5. Speed
RunService.Stepped:Connect(function()
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
        LocalPlayer.Character.Humanoid.WalkSpeed = _G.SpeedEnabled and (BASE_SPEED * _G.SpeedMultiplier) or BASE_SPEED
    end
end)

CreateUI()
